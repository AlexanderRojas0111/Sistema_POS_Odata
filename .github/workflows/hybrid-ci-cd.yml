name: ðŸš€ Hybrid CI/CD Pipeline v2.0.2

on:
  push:
    branches: [ main, develop, hybrid-v2.0.2, feature/* ]
  pull_request:
    branches: [ main, develop ]

env:
  PYTHON_VERSION: '3.13'
  NODE_VERSION: '20'

jobs:
  # ðŸ” Code Quality & Security
  quality:
    name: ðŸ” Code Quality & Security
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout Code
      uses: actions/checkout@v4
      
    - name: ðŸ Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        
    - name: ðŸ“¦ Install Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install -r requirements-dev.txt
        
    - name: ðŸ” Lint with Pylint
      run: |
        pylint app/ --disable=C0114,C0116,R0903 --exit-zero
        
    - name: ðŸŽ¨ Format Check with Black
      run: |
        black --check app/ tests/ --diff
        
    - name: ðŸ”’ Security Scan with Bandit
      run: |
        bandit -r app/ -f json -o bandit-report.json --exit-zero
        
    - name: ðŸ“Š Upload Security Report
      uses: actions/upload-artifact@v3
      with:
        name: security-report
        path: bandit-report.json

  # ðŸ§ª Backend Testing
  backend-tests:
    name: ðŸ§ª Backend Tests
    runs-on: ubuntu-latest
    needs: quality
    
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: test_password
          POSTGRES_USER: test_user
          POSTGRES_DB: test_db
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
          
      redis:
        image: redis:7-alpine
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379
    
    steps:
    - name: ðŸ“¥ Checkout Code
      uses: actions/checkout@v4
      
    - name: ðŸ Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        
    - name: ðŸ“¦ Install Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install -r requirements-dev.txt
        
    - name: ðŸ”§ Setup Test Environment
      run: |
        export DATABASE_URL="postgresql://test_user:test_password@localhost:5432/test_db"
        export REDIS_URL="redis://localhost:6379/0"
        export FLASK_ENV="testing"
        
    - name: ðŸ§ª Run Backend Tests
      run: |
        export DATABASE_URL="postgresql://test_user:test_password@localhost:5432/test_db"
        export REDIS_URL="redis://localhost:6379/0"
        export FLASK_ENV="testing"
        pytest tests/ -v --cov=app --cov-report=xml --cov-report=html
        
    - name: ðŸ“Š Upload Coverage Reports
      uses: codecov/codecov-action@v3
      with:
        file: ./coverage.xml
        flags: backend
        name: backend-coverage

  # ðŸŽ¨ Frontend Testing
  frontend-tests:
    name: ðŸŽ¨ Frontend Tests
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout Code
      uses: actions/checkout@v4
      
    - name: ðŸ“¦ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json
        
    - name: ðŸ“¦ Install Frontend Dependencies
      working-directory: ./frontend
      run: npm ci
      
    - name: ðŸŽ¨ Lint Frontend
      working-directory: ./frontend
      run: npm run lint
      
    - name: ðŸ” Type Check
      working-directory: ./frontend
      run: npm run type-check
      
    - name: ðŸ§ª Run Frontend Tests
      working-directory: ./frontend
      run: npm run test:coverage
      
    - name: ðŸ—ï¸ Build Frontend
      working-directory: ./frontend
      run: npm run build

  # ðŸ³ Docker Build & Test
  docker-build:
    name: ðŸ³ Docker Build & Test
    runs-on: ubuntu-latest
    needs: [backend-tests, frontend-tests]
    
    steps:
    - name: ðŸ“¥ Checkout Code
      uses: actions/checkout@v4
      
    - name: ðŸ³ Setup Docker Buildx
      uses: docker/setup-buildx-action@v3
      
    - name: ðŸ—ï¸ Build Backend Image
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ./Dockerfile.optimized
        target: production
        push: false
        tags: pos-odata-app:test
        cache-from: type=gha
        cache-to: type=gha,mode=max
        
    - name: ðŸ§ª Test Docker Compose
      run: |
        # Crear archivo .env para testing
        echo "DATABASE_URL=postgresql://pos_user:test_password@db:5432/pos_db_test" > .env
        echo "REDIS_URL=redis://redis:6379/0" >> .env
        echo "FLASK_ENV=testing" >> .env
        
        # Test docker-compose build
        docker-compose -f docker-compose.production.yml build
        
    - name: ðŸ”’ Security Scan Docker Image
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: pos-odata-app:test
        format: 'sarif'
        output: 'trivy-results.sarif'
        
    - name: ðŸ“Š Upload Trivy Results
      uses: github/codeql-action/upload-sarif@v2
      with:
        sarif_file: 'trivy-results.sarif'

  # ðŸš€ Integration Tests
  integration-tests:
    name: ðŸš€ Integration Tests
    runs-on: ubuntu-latest
    needs: docker-build
    
    steps:
    - name: ðŸ“¥ Checkout Code
      uses: actions/checkout@v4
      
    - name: ðŸ³ Setup Test Environment
      run: |
        # Crear archivo de entorno para testing
        cp env.example .env
        sed -i 's/development/testing/g' .env
        
        # Iniciar servicios
        docker-compose -f docker-compose.production.yml up -d db redis
        sleep 10
        
    - name: ðŸ§ª Run Integration Tests
      run: |
        # Esperar que los servicios estÃ©n listos
        timeout 60 bash -c 'until docker-compose -f docker-compose.production.yml exec -T db pg_isready -U pos_user; do sleep 1; done'
        
        # Ejecutar tests de integraciÃ³n
        docker-compose -f docker-compose.production.yml run --rm app pytest tests/test_integration_pos_workflow.py -v
        
    - name: ðŸ§¹ Cleanup
      if: always()
      run: |
        docker-compose -f docker-compose.production.yml down -v

  # ðŸ“‹ Health Check Validation
  health-validation:
    name: ðŸ“‹ Health Check Validation
    runs-on: ubuntu-latest
    needs: integration-tests
    
    steps:
    - name: ðŸ“¥ Checkout Code
      uses: actions/checkout@v4
      
    - name: ðŸš€ Deploy Test Environment
      run: |
        cp env.example .env
        docker-compose -f docker-compose.production.yml up -d
        
        # Esperar que los servicios estÃ©n listos
        sleep 30
        
    - name: ðŸ” Validate Health Endpoints
      run: |
        # Test health endpoint
        curl -f http://localhost:5000/health || exit 1
        
        # Test AI health endpoint  
        curl -f http://localhost:5000/ai-test || exit 1
        
        # Test API v1 auth
        TOKEN=$(curl -s -X POST http://localhost:5000/api/v1/auth/login \
          -H "Content-Type: application/json" \
          -d '{"username":"admin","password":"admin"}' | \
          jq -r '.access_token')
          
        if [ "$TOKEN" != "null" ]; then
          echo "âœ… Authentication working"
          
          # Test protected endpoint
          curl -f -H "Authorization: Bearer $TOKEN" \
            http://localhost:5000/api/v1/auth/profile || exit 1
        fi
        
    - name: ðŸ“Š System Status Report
      if: always()
      run: |
        echo "=== CONTAINER STATUS ==="
        docker ps
        
        echo "=== APPLICATION LOGS ==="
        docker logs pos-odata-app --tail 50
        
        echo "=== DATABASE STATUS ==="
        docker exec pos-odata-db pg_isready -U pos_user
        
    - name: ðŸ§¹ Cleanup
      if: always()
      run: |
        docker-compose -f docker-compose.production.yml down -v

  # ðŸŽ¯ Deployment (solo en main)
  deploy:
    name: ðŸŽ¯ Deploy to Production
    runs-on: ubuntu-latest
    needs: [health-validation]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
    - name: ðŸ“¥ Checkout Code
      uses: actions/checkout@v4
      
    - name: ðŸš€ Deploy Notification
      run: |
        echo "ðŸŽ‰ All tests passed! Ready for production deployment."
        echo "ðŸ“‹ Deployment Summary:"
        echo "- âœ… Code quality validated"
        echo "- âœ… Backend tests passed"
        echo "- âœ… Frontend tests passed"
        echo "- âœ… Docker build successful"
        echo "- âœ… Integration tests passed"
        echo "- âœ… Health checks validated"
        echo "- ðŸš€ Ready for production!"

  # ðŸ“Š Status Report
  status-report:
    name: ðŸ“Š Pipeline Status Report
    runs-on: ubuntu-latest
    needs: [quality, backend-tests, frontend-tests, docker-build, integration-tests, health-validation]
    if: always()
    
    steps:
    - name: ðŸ“Š Generate Status Report
      run: |
        echo "# ðŸš€ Hybrid CI/CD Pipeline Report v2.0.2" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## ðŸ“‹ Pipeline Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ needs.quality.result }}" == "success" ]; then
          echo "- âœ… **Code Quality**: Passed" >> $GITHUB_STEP_SUMMARY
        else
          echo "- âŒ **Code Quality**: Failed" >> $GITHUB_STEP_SUMMARY
        fi
        
        if [ "${{ needs.backend-tests.result }}" == "success" ]; then
          echo "- âœ… **Backend Tests**: Passed" >> $GITHUB_STEP_SUMMARY
        else
          echo "- âŒ **Backend Tests**: Failed" >> $GITHUB_STEP_SUMMARY
        fi
        
        if [ "${{ needs.frontend-tests.result }}" == "success" ]; then
          echo "- âœ… **Frontend Tests**: Passed" >> $GITHUB_STEP_SUMMARY
        else
          echo "- âŒ **Frontend Tests**: Failed" >> $GITHUB_STEP_SUMMARY
        fi
        
        if [ "${{ needs.docker-build.result }}" == "success" ]; then
          echo "- âœ… **Docker Build**: Passed" >> $GITHUB_STEP_SUMMARY
        else
          echo "- âŒ **Docker Build**: Failed" >> $GITHUB_STEP_SUMMARY
        fi
        
        if [ "${{ needs.integration-tests.result }}" == "success" ]; then
          echo "- âœ… **Integration Tests**: Passed" >> $GITHUB_STEP_SUMMARY
        else
          echo "- âŒ **Integration Tests**: Failed" >> $GITHUB_STEP_SUMMARY
        fi
        
        if [ "${{ needs.health-validation.result }}" == "success" ]; then
          echo "- âœ… **Health Validation**: Passed" >> $GITHUB_STEP_SUMMARY
        else
          echo "- âŒ **Health Validation**: Failed" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## ðŸŽ¯ Next Steps" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸ“‹ Review test results and coverage reports" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸ” Check security scan results" >> $GITHUB_STEP_SUMMARY  
        echo "- ðŸš€ Deploy to production if all checks pass" >> $GITHUB_STEP_SUMMARY
